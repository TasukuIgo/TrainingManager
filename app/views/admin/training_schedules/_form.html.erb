<%= form_with model: [:admin, @training_schedule], local: true do |f| %>

  <!-- =========================
       バリデーションエラー表示
       ========================= -->
  <% if @training_schedule.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(@training_schedule.errors.count, "件のエラー") %>があります：</h5>
      <ul class="mb-0">
        <% @training_schedule.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- =========================
       研修選択
       ========================= -->
  <div class="mb-3">
    <%= f.label :training_id, "研修", class: "form-label" %>
    <%= f.collection_select :training_id,
          @trainings,
          :id,
          :title,
          {},
          class: "form-select" %>
    <%# Trainingモデルのタイトルをプルダウン表示 %>
  </div>

  <!-- =========================
       開始日時（datetime-local）
       ========================= -->
  <div class="mb-3">
    <%= f.label :start_time, "開始日時", class: "form-label" %>
    <%= f.datetime_local_field :start_time,
          class: "form-control w-auto",
          id: "start_time" %>
    <%# 日付＋時刻を同時に入力 %>
  </div>

  <!-- =========================
       終了時刻（timeのみ）
       ========================= -->
  <div class="mb-3">
    <%= f.label :end_time, "終了時刻", class: "form-label" %>
    <%= f.time_field :end_time,
          class: "form-control w-auto",
          id: "end_time" %>
    <%# 開始日時と連動して自動調整される %>
  </div>

  <!-- =========================
       会場
       ========================= -->
  <div class="mb-3">
    <%= f.label :room_id, "会場", class: "form-label" %>
    <%= f.collection_select :room_id,
          @rooms,
          :id,
          :name,
          { prompt: "未定" },
          class: "form-select" %>
    <%# 未選択でも保存可能 %>
  </div>

  <!-- =========================
       講師
       ========================= -->
  <div class="mb-3">
    <%= f.label :instructor_id, "講師", class: "form-label" %>
    <%= f.collection_select :instructor_id,
          @instructors,
          :id,
          :name,
          { prompt: "未定" },
          class: "form-select" %>
  </div>

  <!-- =========================
       参加者（複数選択）
       ========================= -->
  <div class="mb-3">
    <%= f.label :participant_ids, "参加者", class: "form-label" %>
    <%= f.collection_select :participant_ids,
          @users,
          :id,
          :name,
          { prompt: "未定", multiple: true },
          class: "form-select" %>

    <small class="form-text text-muted">
      参加者がわからない場合は未定で登録してください。
    </small>
  </div>

  <!-- =========================
       操作ボタン
       ========================= -->
  <div class="mt-3">
    <%= f.submit(@training_schedule.persisted? ? "更新" : "作成",
          class: "btn btn-primary") %>

    <%= link_to "戻る",
          admin_training_schedules_path,
          class: "btn btn-secondary ms-2" %>

    <% if @training_schedule.persisted? %>
      <%= link_to "削除",
            admin_training_schedule_path(@training_schedule),
            data: {
              turbo_method: :delete,
              turbo_confirm: "本当に削除しますか？"
            },
            class: "btn btn-danger" %>
    <% end %>
  </div>

  <!-- =========================
       JavaScript
       開始日時と終了時刻の連動処理
       ※ ロジックは変更しない
       ========================= -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {

      // 入力フィールド取得
      const startInput = document.getElementById("start_time");
      const endInput   = document.getElementById("end_time");

      // フィールドが存在しなければ何もしない
      if (!startInput || !endInput) return;

      // 現在時刻（秒・ミリ秒は0にする）
      const now = new Date();
      now.setSeconds(0, 0, 0);

      // Date → yyyy-mm-ddThh:mm（datetime-local用）
      function formatDateTimeLocal(date) {
        const pad = (n) => String(n).padStart(2, "0");
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
      }

      // Date → HH:MM（time用）
      function formatTime(date) {
        return date.toTimeString().slice(0, 5);
      }

      // 開始日時は「現在時刻以降」のみ選択可能
      startInput.min = formatDateTimeLocal(now);

      // 開始日時が変更されたときの処理
      startInput.addEventListener("change", () => {
        const startDate = new Date(startInput.value);
        if (isNaN(startDate)) return;

        // 終了時刻の最大値（当日23:59）
        const endMax = new Date(startDate);
        endMax.setHours(23, 59, 0, 0);

        // 終了時刻の初期値 = 開始 + 1時間
        let initialEnd = new Date(startDate.getTime() + 60 * 60 * 1000);
        if (initialEnd > endMax) initialEnd = endMax;

        // 終了時刻に反映
        endInput.value = formatTime(initialEnd);
        endInput.min   = formatTime(startDate);
        endInput.max   = formatTime(endMax);
      });

      // 初回表示時の初期化
      if (!startInput.value) {
        startInput.value = formatDateTimeLocal(now);
      }

      // 初期化後に change を発火させる
      startInput.dispatchEvent(new Event("change"));
    });
  </script>

<% end %>
