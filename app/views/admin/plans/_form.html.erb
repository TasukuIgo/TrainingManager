<%= form_with model: [:admin, @plan], local: true do |f| %>
  <%# --- 上部ボタン --- %>
  <div class="mb-4 d-flex gap-2">
    <%= f.submit @plan.persisted? ? "更新" : "作成",
        class: "btn btn-primary" %>

    <%= link_to "戻る",
        admin_plans_path,
        class: "btn btn-secondary" %>

    <% if @plan.persisted? %>
      <%= link_to "削除",
          admin_plan_path(@plan),
          data: { turbo_method: :delete, turbo_confirm: "このプランを削除しますか？" },
          class: "btn btn-danger ms-auto" %>
    <% end %>
  </div>

  <%# --- 既存のエラー表示 --- %>
  <% if @plan.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(@plan.errors.count, "件のエラー") %>があります：</h5>
      <ul class="mb-0">
        <% @plan.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# --- ここからフォーム本体 --- %>
  <div class="mb-3">
    <%= f.label :name, "プラン名", class: "form-label" %>
    <%= f.text_field :name, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= f.label :description, "説明", class: "form-label" %>
    <%= f.text_area :description, class: "form-control", rows: 3 %>
  </div>

  <div class="mb-3">
    <%= f.label :user_ids, "受講対象者 *必須", class: "form-label" %>
    <%= f.collection_check_boxes :user_ids, User.all, :id, :name do |b| %>
      <div class="form-check">
        <%= b.check_box class: "form-check-input" %>
        <%= b.label class: "form-check-label" %>
      </div>
    <% end %>
  </div>

  <%# --- 研修スケジュール一覧 --- %>
  <h2 class="mt-4">研修スケジュールを選択</h2>
  <table class="table table-bordered table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th class="text-center">選択</th>
        <th>研修タイトル</th>
        <th>開始日時</th>
        <th>終了日時</th>
        <th>部屋</th>
      </tr>
    </thead>
    <tbody>
      <% @training_schedules.each do |ts| %>
        <tr>
          <td class="text-center">
            <%= f.check_box :training_schedule_ids, { multiple: true }, ts.id, nil %>
          </td>
          <td><%= ts.training.title %></td>
          <td><%= ts.start_time&.strftime("%Y/%m/%d %H:%M") %></td>
          <td><%= ts.end_time&.strftime("%Y/%m/%d %H:%M") %></td>
          <td><%= ts.room&.name %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>
