<div class="calendar-legend mb-3">
  <span class="legend-item">
    <span class="legend-color plan"></span> プラン参加
  </span>
  <span class="legend-item">
    <span class="legend-color training"></span> 研修参加
  </span>
  <span class="legend-item">
    <span class="legend-color instructor"></span> 講師
  </span>
</div>

<div id="<%= calendar_id %>" style="visibility: hidden;"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" data-turbo-track="reload">

<%= stylesheet_link_tag 'calendar', 'data-turbo-track': 'reload' %>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js" data-turbo-track="reload"></script>

  <script>
  document.addEventListener("turbo:load", function() {
    const calendarEl = document.getElementById("<%= calendar_id %>");
    if (!calendarEl) return;

    const events = <%= raw(
      schedules.map { |schedule, role|
        {
          id: schedule.id,
          title: schedule.training&.title || "未設定",
          start: schedule.start_time&.iso8601,
          end: schedule.end_time&.iso8601,
          url: role == :other ? null : url_for_event.call(schedule),
          classNames: [role ? role.to_s : "unassigned"]
        }
      }.to_json
    ) %>;

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      locale: "ja",
      timeZone: "Asia/Tokyo",

      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },

      events: events,

      eventClick(info) {
        if (!info.event.url) {
          info.jsEvent.preventDefault();
          return;
        }
        info.jsEvent.preventDefault();
        window.location.href = info.event.url;
      }
    });

    calendar.render();
    calendarEl.style.visibility = "visible";
  });
  </script>